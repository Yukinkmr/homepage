---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Section from '../../../components/Section.astro';
import { t } from '../../../i18n/utils';
import type { Lang } from '../../../i18n/utils';

export async function getStaticPaths() {
  return [
    { params: { lang: 'ja' } },
    { params: { lang: 'en' } },
  ];
}

const { lang } = Astro.params as { lang: Lang };
const title = t('contact.title', lang);
const endpoint = import.meta.env.PUBLIC_CONTACT_ENDPOINT || '';
---

<BaseLayout title={title} lang={lang}>
  <div class="w-full mx-auto px-6 md:px-8 lg:px-12 xl:px-16 py-12 max-w-4xl">
    <Section 
      title={title}
      description={lang === 'ja' ? 'お問い合わせフォーム' : 'Contact form'}
    >
      <form 
        id="contact-form"
        action={endpoint}
        method="POST"
        class="space-y-6"
      >
        <!-- Honeypot field -->
        <input 
          type="text" 
          name="website" 
          style="display: none;" 
          tabindex="-1" 
          autocomplete="off"
        />
        
        <div>
          <label for="name" class="block text-sm font-medium text-gray-300 mb-2">
            {t('contact.name', lang)} <span class="text-red-400">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-5 py-4 bg-gray-800 border border-gray-700 rounded-xl text-gray-100 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-colors"
          />
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-gray-300 mb-2">
            {t('contact.email', lang)} <span class="text-red-400">*</span>
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-5 py-4 bg-gray-800 border border-gray-700 rounded-xl text-gray-100 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-colors"
          />
        </div>

        <div>
          <label for="message" class="block text-sm font-medium text-gray-300 mb-2">
            {t('contact.message', lang)} <span class="text-red-400">*</span>
          </label>
          <textarea
            id="message"
            name="message"
            rows="6"
            required
            class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-100 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 resize-none"
          ></textarea>
        </div>

        <div id="form-message" class="hidden p-4 rounded-lg"></div>

        <button
          type="submit"
          id="submit-btn"
            class="w-full px-8 py-4 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-cyan-500/20"
        >
          {t('contact.submit', lang)}
        </button>
      </form>
    </Section>
  </div>
</BaseLayout>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const messageDiv = document.getElementById('form-message') as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  
  const lang = window.location.pathname.startsWith('/en') ? 'en' : 'ja';
  const messages = {
    ja: {
      sending: '送信中...',
      success: 'メッセージを送信しました。ありがとうございます。',
      error: 'エラーが発生しました。もう一度お試しください。',
    },
    en: {
      sending: 'Sending...',
      success: 'Message sent successfully. Thank you!',
      error: 'An error occurred. Please try again.',
    },
  };

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Check honeypot
    const honeypot = (form.querySelector('input[name="website"]') as HTMLInputElement).value;
    if (honeypot) {
      return; // Bot detected
    }

    submitBtn.disabled = true;
    submitBtn.textContent = messages[lang].sending;
    messageDiv.classList.add('hidden');

    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          Accept: 'application/json',
        },
      });

      if (response.ok) {
        messageDiv.className = 'p-4 rounded-lg bg-green-900/50 border border-green-700 text-green-300';
        messageDiv.textContent = messages[lang].success;
        messageDiv.classList.remove('hidden');
        form.reset();
      } else {
        throw new Error('Form submission failed');
      }
    } catch (error) {
      messageDiv.className = 'p-4 rounded-lg bg-red-900/50 border border-red-700 text-red-300';
      messageDiv.textContent = messages[lang].error;
      messageDiv.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = lang === 'ja' ? '送信' : 'Submit';
    }
  });
</script>
