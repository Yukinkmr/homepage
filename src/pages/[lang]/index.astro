---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/Section.astro';
import Card from '../../components/Card.astro';
import ProfileSection from '../../components/ProfileSection.astro';
import { t } from '../../i18n/utils';
import profileData from '../../data/profile.json';
import portfolioData from '../../data/portfolio.json';
import type { Lang } from '../../i18n/utils';

export async function getStaticPaths() {
  return [
    { params: { lang: 'ja' } },
    { params: { lang: 'en' } },
  ];
}

const { lang } = Astro.params as { lang: Lang };
const title = lang === 'ja' ? 'ホーム' : 'Home';

const getTitle = (item: { title_ja: string; title_en: string }) => 
  lang === 'ja' ? item.title_ja : item.title_en;
const getSummary = (item: { summary_ja: string; summary_en: string }) => 
  lang === 'ja' ? item.summary_ja : item.summary_en;

const base = import.meta.env.BASE_URL;
const categories = ['soccer', 'research', 'development', 'other'] as const;
const featuredItems = categories.map((category) => {
  const items = portfolioData[category] || [];
  return items
    .filter((item) => item.featured)
    .sort((a, b) => (a.order || 0) - (b.order || 0))
    .slice(0, 3);
});
---

<BaseLayout title={title} lang={lang}>
  <div class="w-full mx-auto px-6 md:px-8 lg:px-12 xl:px-16 py-12">
    <!-- Hero -->
    <div class="py-32 md:py-48 lg:py-64 mb-16 md:mb-24 lg:mb-32 text-center">
      <h1 class="text-6xl md:text-7xl lg:text-8xl font-bold text-gray-100 mb-8 tracking-tight animate-fade-in">
        Yuki's Homepage
      </h1>
      <div class="flex justify-center space-x-4 mb-16 animate-fade-in-delay">
        <a 
          href={`${base}${lang}/contact/`}
          target="_self"
          class="px-8 py-4 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600 transition-colors shadow-lg shadow-cyan-500/20"
        >
          {t('home.contact', lang)}
        </a>
      </div>
    </div>

    <!-- Profile Sections -->
    <ProfileSection 
      lang={lang} 
      profile={profileData}
      name={t('home.hero.name', lang)}
      nameEn={t('home.hero.nameEn', lang)}
      nameJa={t('home.hero.nameJa', lang)}
      university={t('home.hero.university', lang)}
      tagline={t('home.hero.tagline', lang)}
      subtitle={t('home.hero.subtitle', lang)}
      base={base}
    />

    <!-- Featured Categories -->
    <section class="mb-20">
      <div class="mb-12 animate-fade-in-up" data-animate>
        <h2 class="text-4xl md:text-5xl font-bold text-gray-100 mb-4 tracking-tight">
          {t('home.sections.featured', lang)}
        </h2>
        <p class="text-xl text-gray-400 leading-relaxed font-light">
          {lang === 'ja' ? 'サッカー・研究・開発など' : 'Soccer, Research, Development, and more'}
        </p>
      </div>
      {categories.map((category, idx) => {
        const items = featuredItems[idx];
        if (!items || items.length === 0) return null;
        
        return (
          <div id={category} class="mb-12 scroll-mt-20 animate-fade-in-up" data-animate>
            <div class="mb-6">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-3xl md:text-4xl font-bold text-gray-100">
                  {t(`category.${category}`, lang)}
                </h3>
                <a 
                  href={`${base}${lang}/${category}/`}
                  target="_self"
                  class="text-cyan-400 hover:text-cyan-300 font-medium transition-colors"
                >
                  {t('home.viewAll', lang)} →
                </a>
              </div>
              {/* スマホ用インジケーター */}
              <div id={`indicator-${category}`} class="flex gap-2 justify-center md:hidden mb-4">
                {items.map((_, idx) => (
                  <div 
                    class={`h-1 rounded-full transition-all duration-300 ${idx === 0 ? 'bg-cyan-400 w-8' : 'bg-gray-600 w-1'}`}
                    data-indicator-index={idx}
                  ></div>
                ))}
              </div>
            </div>
            {/* スマホ: 横スクロール、PC: グリッド */}
            <div 
              id={`portfolio-scroll-${category}`}
              class="flex md:grid md:grid-cols-3 gap-8 items-stretch overflow-x-auto md:overflow-x-visible snap-x snap-mandatory md:snap-none scrollbar-hide pb-2 md:pb-0"
              style="scroll-behavior: smooth;"
            >
              {items.map((item, cardIdx) => (
                <div class="w-[calc(100vw-3rem)] md:w-auto min-w-[calc(100vw-3rem)] md:min-w-0 flex-shrink-0 md:flex-shrink snap-center animate-fade-in-up" data-animate style={`animation-delay: ${cardIdx * 0.1}s`}>
                  <Card
                    title={getTitle(item)}
                    summary={getSummary(item)}
                    date={item.date}
                    tags={item.tags}
                    links={item.links}
                    image={item.image ? `${base}${item.image.replace(/^\//, '')}` : undefined}
                  />
                </div>
              ))}
            </div>
          </div>
        );
      })}
    </section>
  </div>
</BaseLayout>

<script>
  // ブラウザの戻る/進む操作時のみアンカー位置にスクロール
  if (typeof window !== 'undefined') {
    // ページが履歴から復元された時（戻る/進むボタン）のみアンカー位置にスクロール
    if (window.performance && window.performance.navigation) {
      const navigationType = window.performance.navigation.type;
      // TYPE_BACK_FORWARD = 2 (戻る/進むボタンで来た時)
      if (navigationType === 2) {
        window.addEventListener('load', () => {
          const hash = window.location.hash;
          if (hash) {
            const element = document.querySelector(hash);
            if (element) {
              setTimeout(() => {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }, 100);
            }
          }
        });
      }
    } else if (window.performance && window.performance.getEntriesByType) {
      // PerformanceNavigationTiming APIを使用（新しいブラウザ）
      window.addEventListener('load', () => {
        const navigationEntries = window.performance.getEntriesByType('navigation') as PerformanceNavigationTiming[];
        if (navigationEntries.length > 0) {
          const navigationType = navigationEntries[0].type;
          // 'back_forward'の場合のみアンカー位置にスクロール
          if (navigationType === 'back_forward') {
            const hash = window.location.hash;
            if (hash) {
              const element = document.querySelector(hash);
              if (element) {
                setTimeout(() => {
                  element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
              }
            }
          }
        }
      });
      }
    }
    
    // スマホでのインジケーター更新（手動スクロール時のみ）
    if (typeof window !== 'undefined') {
      const initIndicator = () => {
        if (window.innerWidth >= 768) return; // PCでは実行しない
        
        const portfolioSections = document.querySelectorAll('[id^="portfolio-scroll-"]');
        
        portfolioSections.forEach((section) => {
          const sectionEl = section as HTMLElement;
          
          // 既に初期化済みの場合はスキップ
          if (sectionEl.hasAttribute('data-indicator-initialized')) return;
          sectionEl.setAttribute('data-indicator-initialized', 'true');
          
          // 直接の子要素を取得
          const cards = Array.from(sectionEl.children).filter((child) => 
            child.classList.contains('animate-fade-in-up')
          ) as HTMLElement[];
          const totalCards = cards.length;
          
          if (totalCards <= 1) return;
          
          // カテゴリ名を取得
          const categoryName = sectionEl.id.replace('portfolio-scroll-', '');
          
          // 現在のインデックスを取得
          const getCurrentIndex = () => {
            const scrollLeft = sectionEl.scrollLeft;
            const cardWidth = sectionEl.clientWidth;
            const index = Math.round(scrollLeft / cardWidth);
            return Math.min(index, totalCards - 1);
          };
          
          // インジケーターを更新する関数
          const updateIndicator = (index: number) => {
            const indicator = document.getElementById(`indicator-${categoryName}`);
            if (indicator) {
              const dots = indicator.querySelectorAll('[data-indicator-index]');
              dots.forEach((dot, idx) => {
                const dotEl = dot as HTMLElement;
                if (idx === index) {
                  dotEl.classList.remove('bg-gray-600', 'w-1');
                  dotEl.classList.add('bg-cyan-400', 'w-8');
                } else {
                  dotEl.classList.remove('bg-cyan-400', 'w-8');
                  dotEl.classList.add('bg-gray-600', 'w-1');
                }
              });
            }
          };
          
          // スクロール時にインジケーターを更新
          const handleScroll = () => {
            const currentIndex = getCurrentIndex();
            updateIndicator(currentIndex);
          };
          
          sectionEl.addEventListener('scroll', handleScroll, { passive: true });
          
          // 初期化: 最初のカードのインジケーターを設定
          updateIndicator(0);
        });
      };
      
      // ページ読み込み時とリサイズ時に実行
      window.addEventListener('load', initIndicator);
      window.addEventListener('resize', initIndicator);
    }
  </script>

<style>
  @keyframes slide-in-left {
    from {
      opacity: 0;
      transform: translateX(-50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes slide-in-right {
    from {
      opacity: 0;
      transform: translateX(50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  .animate-slide-in-left {
    animation: slide-in-left 0.8s ease-out forwards;
  }
  
  .animate-slide-in-right {
    animation: slide-in-right 0.8s ease-out forwards;
  }
  
  .animate-fade-in {
    animation: fade-in 1s ease-out 0.3s forwards;
    opacity: 0;
  }
  
  .animate-fade-in-delay {
    animation: fade-in 1s ease-out 0.6s forwards;
    opacity: 0;
  }
  
  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fade-in-up {
    opacity: 0;
  }
  
  .animate-fade-in-up-active {
    animation: fade-in-up 0.6s ease-out forwards;
  }
</style>
